sap.ui.define(["com/demo/demo215/controller/BaseController","sap/m/MessageBox","sap/ui/model/Sorter","sap/ui/model/Filter","com/demo/demo215/util/formatter","sap/ui/model/type/String","sap/m/SearchField"],function(e,t,s,a,l,i,r){"use strict";var o=new sap.m.BusyDialog,n=[];return e.extend("com.demo.demo215.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json")},inox:l,onGo:function(){o.open();var e=this;t.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){o.close()}},initialFocus:"OK"})},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.demo.demo215.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var s=this._oFrag.getFilterBar();this._oBasicSearchField=new r({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});s.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onSearch:function(e){var t=e.getParameter("query"),s=[];if(t){s.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new a({filters:s,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(s){if(s.bindRows){s.getBinding("rows").filter(e)}if(s.bindItems){s.getBinding("items").filter(e)}t.update()})},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),s=e.getParameter("tokens")[0].getKey();t.updateInputField(s);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),s=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||s.length!==0){o.open();var a=this,l=this.getView().getModel("modelA"),i=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),r=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,s),n=new Array(new sap.ui.model.Filter({filters:[i,r],and:true}));l.read("/MaterialBOM",{filters:n,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var s=e.results.length;if(s===e.results.length){var l=new sap.ui.model.json.JSONModel;l.setData(e);var i=a._oFrag.getTable();i.setModel(l);o.close();i.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue(),t=this.getView().byId("idPlant").getValue().toString(),s=this.getView().byId("idBOMUsage").getValue().toString();if(e.length===0||t.length===0||s.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");o.close()}else{var a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"BRF");var l=[],i=[],r=[],u={result:[],totalSum:[]},d=[],g=[],c=[],p=this,m=[],h=[],f=this.getView().getModel("modelA");f.attachBatchRequestSent(function(){o.close()});if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");this.oBusyDialog.close()}else{var w=this.getView().byId("multiInput").getValue();m[0]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t);m[1]=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,s);m[2]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,w)}var M=new sap.m.BusyDialog({text:"Loading Data..."});M.open();f.read("/MaterialBOM",{filters:m,urlParameters:{$select:"BillOfMaterial"},async:false,success:function(e,s){var w=e.results.length;for(var F=0;F<e.results.length;F++){n[F]=e.results[F].BillOfMaterial}if(w===F&&w!==0&&w!==undefined){var B=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),I=new sap.ui.model.Filter({filters:[B],and:true}),y=[];for(var O=0;O<n.length;O++){y.push(new sap.ui.model.Filter("BillOfMaterial",sap.ui.model.FilterOperator.EQ,n[O]))}var v=new sap.ui.model.Filter({filters:y,and:false});m=new Array(new sap.ui.model.Filter({filters:[I,v],and:true}));f=p.getView().getModel("modelA");f.read("/MaterialBOMItem",{filters:[m],urlParameters:{$select:"BillOfMaterialItemQuantity,BillOfMaterialComponent,Material,BillOfMaterial"},async:false,success:function(e,t){for(var s=0;s<e.results.length;s++){g[s]=e.results[s].BillOfMaterialComponent;d[s]=e.results[s].BillOfMaterialItemQuantity;c[s]=e.results[s].Material}if(s===e.results.length&&e.results.length!==0&&e.results.length!==undefined){f=p.getView().getModel("modelB");var n=[];for(O=0;O<g.length;O++){n.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,g[O]))}var w=new sap.ui.model.Filter({filters:n,and:false});m=new Array(new sap.ui.model.Filter({filters:[w]}));f.read("/A_Product",{filters:[m],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(e,t){M.close();for(s=0;s<e.results.length;s++){i[s]=e.results[s].GrossWeight;r[s]=e.results[s].NetWeight;l[s]=e.results[s].WeightUnit;h[s]=e.results[s].Product}if(s===e.results.length&&e.results.length!==0&&e.results.length!==undefined){var o=0,n=0;for(var m=0;m<e.results.length;m++){u.result.push({Mat:h[m],FatMat:c[m],Qty:"",nwt:r[m]+" "+l[m],gwt:i[m]+" "+l[m],tnwt:"",tgwt:""})}for(m=0;m<u.result.length;m++){for(var f=0;f<g.length;f++){if(u.result[m].Mat===g[f]){u.result[m].Qty=d[f];u.result[m].tnwt=r[m]*d[f]+" "+l[m];u.result[m].tgwt=i[m]*d[f]+" "+l[m]}}}for(m=0;m<u.result.length;m++){o=o+parseFloat(u.result[m].tnwt.split(" ")[0]);n=n+parseFloat(u.result[m].tgwt.split(" ")[0])}u.totalSum.push({addNQ:o,addGQ:n,Label:"Total"});a=new sap.ui.model.json.JSONModel;a.setData(u);p.getView().setModel(a,"BRF")}},error:function(e){o.close();M.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){o.close();M.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}else{o.close();M.close();sap.m.MessageToast.show("No Records Found")}},error:function(e){o.close();M.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){p.getView().byId("multiInput").setValue(null);p.getView().byId("idPlant").setValue(null);p.getView().byId("idBOMUsage").setValue(null);return}}})}})}},onDataExport:function(){this.onExcelDownload(this)},handleGroupButtonPressed:function(){this._oDialog=sap.ui.xmlfragment("com.demo.demo215.view.SettingsDialog",this);this._oDialog.open()},handleFilterButtonPressed:function(){this._oDialog=sap.ui.xmlfragment("com.demo.demo215.view.FilterDialog",this);this._oDialog.open()},handleGroupDialogConfirm:function(e){this.mGroupFunctions={FatMat:function(e){var t=e.getProperty("FatMat");return{key:t,text:t+" "+"(Father)"}}};var t=this.byId("tab"),a=e.getParameters(),l=t.getBinding("items"),i,r,o,n=[];if(a.groupItem){i=a.groupItem.getKey();r=a.groupDescending;o=this.mGroupFunctions[i];n.push(new s(i,r,o));l.sort(n)}},handleFilterDialogConfirm:function(e){var t=this.byId("tab"),s=e.getParameters(),l=t.getBinding("items"),i=[];s.filterItems.forEach(function(e){var t=e.getKey().split("___"),s=t[0],l=t[1],r=parseInt(t[2],10),o=t[3],n=new a(s,l,r,o);i.push(n)});l.filter(i);this.byId("vsdFilterBar").setVisible(i.length>0);this.byId("vsdFilterLabel").setText(s.filterString)}})});