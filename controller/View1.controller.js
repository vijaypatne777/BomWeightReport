sap.ui.define(["com/bom/bomweight/controller/BaseController","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/m/SearchField","sap/ui/model/Filter","sap/m/MessageBox","com/bom/bomweight/util/formatter"],function(e,t,a,s,l,r,i){"use strict";var o=new sap.m.BusyDialog;return e.extend("com.bom.bomweight.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json");var e=new a({worklistTableTitle:this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView")},inox:i,onGo:function(){o.open();var e=this;r.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){o.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue(),t=this.getView().byId("idPlant").getValue(),a=this.getView().byId("idBOMUsage").getValue();if(e.length===0||t.length===0||a.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");o.close()}else{var s=this;var l=new sap.ui.model.json.JSONModel;this.getView().setModel(l,"BRF");var r=[];var i=[];var n=false;var u="";var g=0;var d=true;var m=[];var c=0;var p=0;var f="";var h=0;var M=false;var B=new sap.ui.model.json.JSONModel;var v=new sap.ui.model.json.JSONModel;var w=new sap.ui.model.json.JSONModel;var O=[];var I=0;var y="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var b=new sap.ui.model.odata.ODataModel(y,true);b.setDefaultBindingMode("TwoWay");b.read("/MaterialBOM",{urlParameters:{$filter:"BillOfMaterialVariantUsage eq '"+a+"' and Plant eq '"+t+"' and Material eq '"+e+"'",$select:"Material"},async:false,success:function(e,a){for(var s=0;s<e.results.length;s++){r[s]=e.results[s].Material}var l="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var w=new sap.ui.model.odata.ODataModel(l,true);w.setDefaultBindingMode("TwoWay");c=r.length;do{m=[];m[0]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,r[p]);m[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t);w.read("/MaterialBOMItem",{filters:m,urlParameters:{$select:"BillOfMaterialCategory,BillOfMaterialVariant,BillOfMaterialVersion,BillOfMaterialItemNodeNumber,Material,Plant,BillOfMaterialItemUUID,ValidityStartDate,ValidityEndDate,EngineeringChangeDocument,BillOfMaterialComponent,BillOfMaterialItemCategory,BillOfMaterialItemNumber,BillOfMaterialItemUnit,BillOfMaterialItemQuantity,IsAssembly,ComponentDescription,BOMItemIsSalesRelevant,IsProductionRelevant,BOMItemIsCostingRelevant,IsEngineeringRelevant,RequiredComponent,IsSubItem,BillOfMaterial,SpecialProcurementType"},async:false,success:function(e,t){var a=e.results[0].BillOfMaterial;var s=e.results[0].BillOfMaterialCategory;var l=e.results[0].BillOfMaterialVariant;var r=e.results[0].BillOfMaterialVersion;var n=e.results[0].EngineeringChangeDocument;var c=e.results[0].Material;var p=e.results[0].Plant;var y="/MaterialBOM(BillOfMaterial='"+a+"',BillOfMaterialCategory='"+s+"',BillOfMaterialVariant='"+l+"',BillOfMaterialVersion='"+r+"',EngineeringChangeDocument='"+n+"',Material='"+c+"',Plant='"+p+"')";w.read(y,{filters:m,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e,t){f=e.BillOfMaterialVariantUsage},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});if(!M){}else{h=h+1;M=false}if(d){v.setData(e);d=false}else{B.setData(e);for(var b=0;b<B.getProperty("/results").length;b++){v.getProperty("/results").push(B.getProperty("/results/"+b))}}for(var b=0;b<e.results.length;b++){if(e.results[b].IsAssembly.length>0){u="X";i[g]=e.results[b].BillOfMaterialComponent;O[I]=e.results[b].BillOfMaterialComponent;I++;g++}}if(i.length>0){u="X"}else{u=""}},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});p=p+1;if(p<r.length){n=true}else if(u.length>0){r=[];r=i;p=0;M=true;g=0;i=[];n=true}else{n=false}}while(n)},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){s.getView().byId("multiInput").setValue(null);s.getView().byId("idPlant").setValue(null);s.getView().byId("idBOMUsage").setValue(null);return}}})}});var V=v.getData();var F=[];var S=[];var P=[];var N=[];for(var C=0;C<V.results.length;C++){F.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,V.results[C].BillOfMaterialComponent))}var x=new sap.ui.model.Filter({filters:F,and:false});var W=new Array(new sap.ui.model.Filter({filters:[x]}));var A={p:[],s:[],m:[]};var D=this.getView().getModel("modelB");D.read("/A_Product",{filters:[W],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(t,a){for(B=0;B<t.results.length;B++){S[B]=t.results[B].GrossWeight;P[B]=t.results[B].NetWeight;N[B]=t.results[B].WeightUnit}if(B===t.results.length&&t.results.length!==0&&t.results.length!==undefined){var r=0,i=0;for(c=0;c<V.results.length;c++){for(B=0;B<t.results.length;B++){if(t.results[B].Product===V.results[c].BillOfMaterialComponent){A.p.push({asm:V.results[c].IsAssembly,itm:V.results[c].BillOfMaterialItemNumber,bmc:V.results[c].BillOfMaterialComponent,mat:V.results[c].Material,qty:V.results[c].BillOfMaterialItemQuantity,gro:t.results[B].GrossWeight+" "+t.results[B].WeightUnit,net:t.results[B].NetWeight+" "+t.results[B].WeightUnit,tgt:t.results[B].GrossWeight*V.results[c].BillOfMaterialItemQuantity+" "+t.results[B].WeightUnit,tnt:t.results[B].NetWeight*V.results[c].BillOfMaterialItemQuantity+" "+t.results[B].WeightUnit,mgw:t.results[B].GrossWeight+" "+t.results[B].WeightUnit,mnw:t.results[B].NetWeight+" "+t.results[B].WeightUnit})}}}for(B=0;B<A.p.length;B++){if(A.p[B].asm.length===0){r=r+parseFloat(A.p[B].tnt.split(" ")[0]);i=i+parseFloat(A.p[B].tgt.split(" ")[0])}}A.s.push({addNQ:r,addGQ:i,label:"Total"});D.read("/A_Product",{urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit",$filter:"(Product eq '"+e+"')"},async:false,success:function(e,t){var a=e.results[0].NetWeight,r=e.results[0].GrossWeight,i=e.results[0].WeightUnit;if(e.results.length===1){A.m.push({mmNW:a+" "+i,mmGW:r+" "+i});o.close();l=new sap.ui.model.json.JSONModel;l.setSizeLimit(A.p.length);l.setData(A);s.getView().setModel(l,"BRF");s.onInitGrouping("mat")}else{sap.m.MMessageToast.show("Issue in fetched Data")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},onInitGrouping:function(e){var a=this.getView().byId("multiInput").getValue();this.mGroupFunctions={mat:function(e){var t=e.getProperty("mat");if(t===a){var s=e.getModel().oData.m[0].mmGW,l=e.getModel().oData.m[0].mmNW;return{key:t,text:t+" "+"(Father)"+Array(241).fill(" ").join("")+l+Array(20).fill(" ").join("")+s}}else{var r=e.getModel().oData.p;var i=[];for(var o=0;o<r.length;o++){i.push(r[o].bmc)}var n=i.indexOf(t);var u=r[n].mnw;var g=r[n].mgw;return{key:t,text:t+Array(255).fill(" ").join("")+u+Array(20).fill(" ").join("")+g}}}};var s=this.byId("tab"),l=s.getBinding("items"),r,i,o,n=[];if(e){r=e;i=false;o=this.mGroupFunctions[r];n.push(new t(r,null,o));l.sort(n)}},onUpdateFinished:function(e){var t,a=e.getSource(),s=e.getParameter("total");if(s&&a.getBinding("items").isLengthFinal()){t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitleCount",[s])}else{t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.bom.bomweight.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var a=this._oFrag.getFilterBar();this._oBasicSearchField=new s({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});a.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),a=e.getParameter("tokens")[0].getKey();t.updateInputField(a);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),a=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||a.length!==0){o.open();var s=this,l=this.getView().getModel("modelA"),r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),i=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,a),n=new Array(new sap.ui.model.Filter({filters:[r,i],and:true}));l.read("/MaterialBOM",{filters:n,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var a=e.results.length;if(a===e.results.length){var l=new sap.ui.model.json.JSONModel;l.setData(e);var r=s._oFrag.getTable();r.setModel(l);o.close();r.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onSearch:function(e){var t=e.getParameter("query"),a=[];if(t){a.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new l({filters:a,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onDataExport:function(){this.onExcelDownload(this)}})});