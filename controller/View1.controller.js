sap.ui.define(["com/bom/bomweight/controller/BaseController","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/m/SearchField","sap/ui/model/Filter","sap/m/MessageBox","com/bom/bomweight/util/formatter"],function(e,t,s,a,l,r,i){"use strict";var o=new sap.m.BusyDialog;return e.extend("com.bom.bomweight.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json");var e=new s({worklistTableTitle:this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView")},inox:i,onGo:function(){o.open();var e=this;r.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){o.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue(),t=this.getView().byId("idPlant").getValue(),s=this.getView().byId("idBOMUsage").getValue();if(e.length===0||t.length===0||s.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");o.close()}else{var a=this;var l=new sap.ui.model.json.JSONModel;this.getView().setModel(l,"BRF");var r=[];var i=[];var n=false;var u="";var g=0;var d=true;var c=[];var m=0;var p=0;var f="";var h=0;var M=false;var B=new sap.ui.model.json.JSONModel;var v=new sap.ui.model.json.JSONModel;var w=new sap.ui.model.json.JSONModel;var I=[];var O=0;var y="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var b=new sap.ui.model.odata.ODataModel(y,true);b.setDefaultBindingMode("TwoWay");b.read("/MaterialBOM",{urlParameters:{$filter:"BillOfMaterialVariantUsage eq '"+s+"' and Plant eq '"+t+"' and Material eq '"+e+"'",$select:"Material"},async:false,success:function(e,s){for(var a=0;a<e.results.length;a++){r[a]=e.results[a].Material}var l="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var w=new sap.ui.model.odata.ODataModel(l,true);w.setDefaultBindingMode("TwoWay");m=r.length;do{c=[];c[0]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,r[p]);c[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t);w.read("/MaterialBOMItem",{filters:c,urlParameters:{$select:"BillOfMaterialCategory,BillOfMaterialVariant,BillOfMaterialVersion,BillOfMaterialItemNodeNumber,Material,Plant,BillOfMaterialItemUUID,ValidityStartDate,ValidityEndDate,EngineeringChangeDocument,BillOfMaterialComponent,BillOfMaterialItemCategory,BillOfMaterialItemNumber,BillOfMaterialItemUnit,BillOfMaterialItemQuantity,IsAssembly,ComponentDescription,BOMItemIsSalesRelevant,IsProductionRelevant,BOMItemIsCostingRelevant,IsEngineeringRelevant,RequiredComponent,IsSubItem,BillOfMaterial,SpecialProcurementType"},async:false,success:function(e,t){var s=e.results[0].BillOfMaterial;var a=e.results[0].BillOfMaterialCategory;var l=e.results[0].BillOfMaterialVariant;var r=e.results[0].BillOfMaterialVersion;var n=e.results[0].EngineeringChangeDocument;var m=e.results[0].Material;var p=e.results[0].Plant;var y="/MaterialBOM(BillOfMaterial='"+s+"',BillOfMaterialCategory='"+a+"',BillOfMaterialVariant='"+l+"',BillOfMaterialVersion='"+r+"',EngineeringChangeDocument='"+n+"',Material='"+m+"',Plant='"+p+"')";w.read(y,{filters:c,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e,t){f=e.BillOfMaterialVariantUsage},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});if(!M){}else{h=h+1;M=false}if(d){v.setData(e);d=false}else{B.setData(e);for(var b=0;b<B.getProperty("/results").length;b++){v.getProperty("/results").push(B.getProperty("/results/"+b))}}for(var b=0;b<e.results.length;b++){if(e.results[b].IsAssembly.length>0){u="X";i[g]=e.results[b].BillOfMaterialComponent;I[O]=e.results[b].BillOfMaterialComponent;O++;g++}}if(i.length>0){u="X"}else{u=""}},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});p=p+1;if(p<r.length){n=true}else if(u.length>0){r=[];r=i;p=0;M=true;g=0;i=[];n=true}else{n=false}}while(n)},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){a.getView().byId("multiInput").setValue(null);a.getView().byId("idPlant").setValue(null);a.getView().byId("idBOMUsage").setValue(null);return}}})}});var V=v.getData();var F=[];var S=[];var P=[];var N=[];for(var C=0;C<V.results.length;C++){F.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,V.results[C].BillOfMaterialComponent))}var x=new sap.ui.model.Filter({filters:F,and:false});var W=new Array(new sap.ui.model.Filter({filters:[x]}));var T={p:[],s:[],m:[]};var A=this.getView().getModel("modelB");A.read("/A_Product",{filters:[W],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(t,s){for(B=0;B<t.results.length;B++){S[B]=t.results[B].GrossWeight;P[B]=t.results[B].NetWeight;N[B]=t.results[B].WeightUnit}if(B===t.results.length&&t.results.length!==0&&t.results.length!==undefined){var r=0,i=0;for(m=0;m<V.results.length;m++){for(B=0;B<t.results.length;B++){if(t.results[B].Product===V.results[m].BillOfMaterialComponent){T.p.push({asm:V.results[m].IsAssembly,itm:V.results[m].BillOfMaterialItemNumber,bmc:V.results[m].BillOfMaterialComponent,mat:V.results[m].Material,qty:V.results[m].BillOfMaterialItemQuantity,gro:t.results[B].GrossWeight+" "+t.results[B].WeightUnit,net:t.results[B].NetWeight+" "+t.results[B].WeightUnit,tgt:t.results[B].GrossWeight*V.results[m].BillOfMaterialItemQuantity+" "+t.results[B].WeightUnit,tnt:t.results[B].NetWeight*V.results[m].BillOfMaterialItemQuantity+" "+t.results[B].WeightUnit,mgw:t.results[B].GrossWeight+" "+t.results[B].WeightUnit,mnw:t.results[B].NetWeight+" "+t.results[B].WeightUnit})}}}for(B=0;B<T.p.length;B++){if(T.p[B].asm.length===0){r=r+parseFloat(T.p[B].tnt.split(" ")[0]);i=i+parseFloat(T.p[B].tgt.split(" ")[0])}}T.s.push({addNQ:r,addGQ:i,label:"Total"});A.read("/A_Product",{urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit",$filter:"(Product eq '"+e+"')"},async:false,success:function(e,t){var s=e.results[0].NetWeight,r=e.results[0].GrossWeight,i=e.results[0].WeightUnit;if(e.results.length===1){T.m.push({mmNW:s+" "+i,mmGW:r+" "+i});o.close();l=new sap.ui.model.json.JSONModel;l.setData(T);a.getView().setModel(l,"BRF");a.onInitGrouping("mat")}else{sap.m.MMessageToast.show("Issue in fethced Data")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},onInitGrouping:function(e){var s=this.getView().byId("multiInput").getValue();this.mGroupFunctions={mat:function(e){var t=e.getProperty("mat");if(t===s){return{key:t,text:t+" "+"(Father)"}}else{return{key:t,text:t}}}};var a=this.byId("tab"),l=a.getBinding("items"),r,i,o,n=[];if(e){r=e;i=true;o=this.mGroupFunctions[r];n.push(new t(r,i,o));delete n[0].bDescending;l.sort(n)}},onUpdateFinished:function(e){var t,s=e.getSource(),a=e.getParameter("total");if(a&&s.getBinding("items").isLengthFinal()){t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitleCount",[a])}else{t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.bom.bomweight.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var s=this._oFrag.getFilterBar();this._oBasicSearchField=new a({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});s.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),s=e.getParameter("tokens")[0].getKey();t.updateInputField(s);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),s=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||s.length!==0){o.open();var a=this,l=this.getView().getModel("modelA"),r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),i=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,s),n=new Array(new sap.ui.model.Filter({filters:[r,i],and:true}));l.read("/MaterialBOM",{filters:n,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var s=e.results.length;if(s===e.results.length){var l=new sap.ui.model.json.JSONModel;l.setData(e);var r=a._oFrag.getTable();r.setModel(l);o.close();r.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onSearch:function(e){var t=e.getParameter("query"),s=[];if(t){s.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new l({filters:s,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(s){if(s.bindRows){s.getBinding("rows").filter(e)}if(s.bindItems){s.getBinding("items").filter(e)}t.update()})},onDataExport:function(){this.onExcelDownload(this)}})});