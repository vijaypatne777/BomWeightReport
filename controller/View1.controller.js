sap.ui.define(["com/bom/bomweight/controller/BaseController","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/m/SearchField","sap/ui/model/Filter","sap/m/MessageBox","com/bom/bomweight/util/formatter"],function(e,t,s,a,r,l,i){"use strict";var n=new sap.m.BusyDialog,o=false;return e.extend("com.bom.bomweight.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json");this.oColModelPlant=new sap.ui.model.json.JSONModel("Columns/columnPlant.json");var e=new s({worklistTableTitle:this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView")},inox:i,onGo:function(){n.open();var e=this;l.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){n.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue();$.sap.fm=e;var t=this.getView().byId("idPlant").getValue();if(e.length===0||t.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");n.close()}else{$.sap.myVar=true;$.sap.myVars=true;var s=this;var a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"BRF");var r=new Promise(function(e,t){s.connectServer(e,t)});r.then(function(t){var r={results:""};r.results=t;s.getView().byId("idBOMUsage").setValue(r.results[0].usg);var l=[];var i=[];var o=[];var u=[];for(var g=0;g<r.results.length;g++){l.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,r.results[g].bom))}var d=new sap.ui.model.Filter({filters:l,and:false});var c=new Array(new sap.ui.model.Filter({filters:[d]}));var m={p:[],s:[],m:[]};var h=s.getView().getModel("modelB");h.read("/A_Product",{filters:[c],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(t,l){for(var g=0;g<t.results.length;g++){i[g]=t.results[g].GrossWeight;o[g]=t.results[g].NetWeight;u[g]=t.results[g].WeightUnit}if(g===t.results.length&&t.results.length!==0&&t.results.length!==undefined){var d=0,c=0;var f=0;for(var p=0;p<r.results.length;p++){for(g=0;g<t.results.length;g++){if(t.results[g].Product===r.results[p].bom){f+=1;m.p.push({lvl:r.results[p].lvl,asm:r.results[p].asm,itm:r.results[p].itm,bmc:r.results[p].bom,mat:r.results[p].mat,qty:r.results[p].qty,gro:t.results[g].GrossWeight,net:t.results[g].NetWeight,tgt:t.results[g].GrossWeight*r.results[p].qty,tnt:t.results[g].NetWeight*r.results[p].qty,mgw:t.results[g].GrossWeight+" "+t.results[g].WeightUnit,mnw:t.results[g].NetWeight+" "+t.results[g].WeightUnit,cmd:r.results[p].des,wun:t.results[g].WeightUnit,cnt:f,dia:"",gol:""})}}}for(g=0;g<m.p.length;g++){if(m.p[g].asm.length===0){d=d+parseFloat(m.p[g].tnt);c=c+parseFloat(m.p[g].tgt)}}m.s.push({addNQ:d,addGQ:c,label:"Total"});h.read("/A_Product",{urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit",$filter:"(Product eq '"+e+"')"},async:false,success:function(e,t){var r=e.results[0].NetWeight,l=e.results[0].GrossWeight,i=e.results[0].WeightUnit;if(e.results.length===1){m.m.push({mmNW:r+" "+i,mmGW:l+" "+i});var o=JSON.parse(JSON.stringify(m.p));o[0].dia=r+" "+i;o[0].gol=l+" "+i;var u=new sap.ui.model.json.JSONModel;u.setSizeLimit(o.length);u.setData(o);s.getView().setModel(u,"OPM");n.close();a=new sap.ui.model.json.JSONModel;a.setSizeLimit(m.p.length);a.setData(m);s.getView().setModel(a,"BRF")}else{sap.m.MMessageToast.show("Issue in fetched Data")}},error:function(e){n.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){n.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},function(){})}},connectServer:function(e,t){var s=new sap.ui.model.json.JSONModel;this.getView().setModel(s,"BRF");var a=0,r=false,l,i=[],o=true,u=0,g=[],d=[],c=[],m=0;var h=this.getView().byId("multiInput").getValue();var f=this.getView().byId("idPlant").getValue();var p=[];p.push(h);var v=this.getView().getModel("modelA");$.sap.brk=v;var w=this;var M=function(t,s){if(s===undefined||s.length===0||t===null){n.close();e(i);return 1}for(var h=0;h<s.length;h++){d.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,s[h]),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,f)],and:true}))}c.push(new sap.ui.model.Filter({filters:d,and:false}));var v=function(e){return new Promise(function(s,a){t.read(e,{filters:c,urlParameters:{$select:"BillOfMaterialComponent,Plant,IsAssembly,Material,BillOfMaterialItemNumber,ComponentDescription,BillOfMaterialItemQuantity",$orderby:"BillOfMaterialItemNumber"},async:false,success:function(e){s(e)},error:function(e){a(e)}})})};var b=function(e){return new Promise(function(s,a){t.read(e,{filters:c,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e){s(e)},error:function(e){a(e)}})})};Promise.all([v("/MaterialBOMItem"),b("/MaterialBOM")]).then(function(e){m+=1;for(var t=0;t<e[0].results.length;t++){for(var s=0;s<e[1].results.length;s++){if(e[0].results[t].Material===e[1].results[s].Material){u+=1;g.push({mat:e[0].results[t].Material,itm:e[0].results[t].BillOfMaterialItemNumber,bom:e[0].results[t].BillOfMaterialComponent,asm:e[0].results[t].IsAssembly,des:e[0].results[t].ComponentDescription,qty:e[0].results[t].BillOfMaterialItemQuantity,usg:e[1].results[s].BillOfMaterialVariantUsage,lvl:m,idx:u})}}}if(o){for(var n=0;n<p.length;n++){for(var f=0;f<g.length;f++){if(p[n]===g[f].mat){i.push(g[f])}}}}if(e[0].results===undefined||e[0].results.length===0||e[1].results===undefined||e[1].results.length===0){alert(g.length);M(null,null)}if(r){for(var v=0;v<i.length;v++){for(var b=0;b<g.length;b++){if(i[v].bom===g[b].mat){i[v].asm="X";a+=1;i.splice(v+a,0,g[b])}}a=0}}g=[];o=false;r=true;l=[];var F=e[0].results;var P=[],y=[];for(h=0;h<F.length;h++){P.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,F[h].BillOfMaterialComponent),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,F[h].Plant)],and:true}))}y.push(new sap.ui.model.Filter({filters:P,and:false}));var B=w.getView().getModel("modelA");var I=function(e){return new Promise(function(t,s){B.read(e,{filters:y,urlParameters:{$select:"Material"},success:function(e){t(e)},error:function(){}})})};I("/MaterialBOM").then(function(e){for(var t=0;t<e.results.length;t++){l.push(e.results[t].Material)}d=[];c=[];M($.sap.brk,l)})})};M($.sap.brk,p)},onInitGrouping:function(e){var s=$.sap.fm;if(o){var a=false;var r=false;var l=[];var i="lvl";var n=this.getView();var u=n.byId("tab");var g=u.getBinding("items");l.push(new sap.ui.model.Sorter(i,a,r));g.sort(l);o=false}else{this.mGroupFunctions={mat:function(e){var t=e.getProperty("mat");o=true;if(t===s){var a=e.getModel().oData.m[0].mmGW,r=e.getModel().oData.m[0].mmNW;return{key:t,text:t+Array(33).fill(" ").join("")+r+Array(6).fill(" ").join("")+a+Array(5).fill(" ").join("")}}else{o=true;var l=e.getModel().oData.p;var i=[];for(var n=0;n<l.length;n++){i.push(l[n].bmc)}var u=i.indexOf(t);var g=l[u].mnw;var d=l[u].mgw;return{key:t,text:t+Array(33).fill(" ").join("")+g+Array(6).fill(" ").join("")+d}}}};var u=this.byId("tab"),g=u.getBinding("items"),d,c=false,m,h=[],f="cnt";if(e){d=e;c=false;m=this.mGroupFunctions[d];h.push(new t(f,c,m));g.sort(h)}}},onUpdateFinished:function(e){var t,s=e.getSource(),a=e.getParameter("total");if(a&&s.getBinding("items").isLengthFinal()){t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitleCount",[a])}else{t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.bom.bomweight.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var s=this._oFrag.getFilterBar();this._oBasicSearchField=new a({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});s.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onFragNext:function(){if(!this._oFragPlant){this._oFragPlant=sap.ui.xmlfragment("com.bom.bomweight.Fragments.PlantHelp",this)}var e=this._oFragPlant.getTable();this.fTablePlant=e;e.setModel(this.oColModelPlant,"columns");this._oFrag.setRangeKeyFields([{label:"Plant",key:"Plant"}]);this._oFragPlant.open()},onValueHelpCancelPressPlant:function(){this._oFragPlant.close()},onFilterBarSearchPlant:function(){var e=this.getView().getModel("modelC");var t=this;n.open();e.read("/YY1_Plant_API",{async:false,success:function(e,s){var a=e.results.length;if(a===e.results.length){var r=new sap.ui.model.json.JSONModel;r.setData(e);var l=t._oFragPlant.getTable();l.setModel(r);n.close();l.bindRows("/results")}else{n.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){n.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},onValueHelpOkPressPlant:function(e){var t=sap.ui.getCore().byId("PlantId"),s=e.getParameter("tokens")[0].getKey();t.updateInputField(s);this._oFragPlant.close()},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),s=e.getParameter("tokens")[0].getKey();t.updateInputField(s);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),s=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||s.length!==0){n.open();var a=this,r=this.getView().getModel("modelA"),l=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),i=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,s),o=new Array(new sap.ui.model.Filter({filters:[l,i],and:true}));r.read("/MaterialBOM",{filters:o,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var s=e.results.length;if(s===e.results.length){var r=new sap.ui.model.json.JSONModel;r.setData(e);var l=a._oFrag.getTable();l.setModel(r);n.close();l.bindRows("/results")}else{n.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){n.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onSearch:function(e){var t=e.getParameter("query"),s=[];if(t){s.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new r({filters:s,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(s){if(s.bindRows){s.getBinding("rows").filter(e)}if(s.bindItems){s.getBinding("items").filter(e)}t.update()})},onDataExport:function(){this.onExcelDownload(this)},handleGroupButtonPressed:function(){$.sap.n2=true;$.sap.n3=true;this.onInitGrouping("mat")},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("idPlant").setValue(t.toUpperCase())}})});