sap.ui.define(["com/bom/bomweight/controller/BaseController","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/m/SearchField","sap/ui/model/Filter","sap/m/MessageBox","com/bom/bomweight/util/formatter"],function(e,t,a,s,l,r,i){"use strict";var o=new sap.m.BusyDialog,n=false;return e.extend("com.bom.bomweight.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json");this.oColModelPlant=new sap.ui.model.json.JSONModel("Columns/columnPlant.json");var e=new a({worklistTableTitle:this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView")},inox:i,onGo:function(){o.open();var e=this;r.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){o.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue();$.sap.fm=e;var t=this.getView().byId("idPlant").getValue(),a=this.getView().byId("idBOMUsage").getValue();if(e.length===0||t.length===0||a.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");o.close()}else{$.sap.myVar=true;$.sap.myVars=true;var s=this;var l=new sap.ui.model.json.JSONModel;this.getView().setModel(l,"BRF");var r=[];var i=[];var n=false;var u="";var g=0;var d=true;var c=[];var m=0;var p=0;var f="";var h=0;var M=false;var v=new sap.ui.model.json.JSONModel;var B=new sap.ui.model.json.JSONModel;var w=new sap.ui.model.json.JSONModel;var I=[];var O=0;var y="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var b=new sap.ui.model.odata.ODataModel(y,true);b.setDefaultBindingMode("TwoWay");b.read("/MaterialBOM",{urlParameters:{$filter:"BillOfMaterialVariantUsage eq '"+a+"' and Plant eq '"+t+"' and Material eq '"+e+"'",$select:"Material"},async:false,success:function(e,a){for(var s=0;s<e.results.length;s++){r[s]=e.results[s].Material}if(e.results===undefined||e.results.length===0){o.close();sap.m.MessageToast.show("No Valid Records Found");return}var l="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var w=new sap.ui.model.odata.ODataModel(l,true);w.setDefaultBindingMode("TwoWay");m=r.length;do{c=[];c[0]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,r[p]);c[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t);w.read("/MaterialBOMItem",{filters:c,urlParameters:{$select:"BillOfMaterialCategory,BillOfMaterialVariant,BillOfMaterialVersion,BillOfMaterialItemNodeNumber,Material,Plant,BillOfMaterialItemUUID,ValidityStartDate,ValidityEndDate,EngineeringChangeDocument,BillOfMaterialComponent,BillOfMaterialItemCategory,BillOfMaterialItemNumber,BillOfMaterialItemUnit,BillOfMaterialItemQuantity,IsAssembly,ComponentDescription,BOMItemIsSalesRelevant,IsProductionRelevant,BOMItemIsCostingRelevant,IsEngineeringRelevant,RequiredComponent,IsSubItem,BillOfMaterial,SpecialProcurementType"},async:false,success:function(e,t){var a=e.results[0].BillOfMaterial;var s=e.results[0].BillOfMaterialCategory;var l=e.results[0].BillOfMaterialVariant;var r=e.results[0].BillOfMaterialVersion;var n=e.results[0].EngineeringChangeDocument;var m=e.results[0].Material;var p=e.results[0].Plant;var y="/MaterialBOM(BillOfMaterial='"+a+"',BillOfMaterialCategory='"+s+"',BillOfMaterialVariant='"+l+"',BillOfMaterialVersion='"+r+"',EngineeringChangeDocument='"+n+"',Material='"+m+"',Plant='"+p+"')";w.read(y,{filters:c,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e,t){f=e.BillOfMaterialVariantUsage},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});if(!M){}else{h=h+1;M=false}if(d){for(var b=0;b<e.results.length;b++){e.results[b].IsSubItem=h}B.setData(e);d=false}else{for(var P=0;P<e.results.length;P++){e.results[P].IsSubItem=h}v.setData(e);for(var S=0;S<v.getProperty("/results").length;S++){B.getProperty("/results").push(v.getProperty("/results/"+S))}}for(var S=0;S<e.results.length;S++){if(e.results[S].IsAssembly.length>0){u="X";i[g]=e.results[S].BillOfMaterialComponent;I[O]=e.results[S].BillOfMaterialComponent;O++;g++}}if(i.length>0){u="X"}else{u=""}},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});p=p+1;if(p<r.length){n=true}else if(u.length>0){r=[];r=i;p=0;M=true;g=0;i=[];n=true}else{n=false}}while(n)},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){s.getView().byId("multiInput").setValue(null);s.getView().byId("idPlant").setValue(null);s.getView().byId("idBOMUsage").setValue(null);return}}})}});var P=B.getData();var S=[];var F=[];var V=[];var N=[];for(var C=0;C<P.results.length;C++){S.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,P.results[C].BillOfMaterialComponent))}var x=new sap.ui.model.Filter({filters:S,and:false});var A=new Array(new sap.ui.model.Filter({filters:[x]}));var T={p:[],s:[],m:[]};var D=this.getView().getModel("modelB");D.read("/A_Product",{filters:[A],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(t,a){for(v=0;v<t.results.length;v++){F[v]=t.results[v].GrossWeight;V[v]=t.results[v].NetWeight;N[v]=t.results[v].WeightUnit}if(v===t.results.length&&t.results.length!==0&&t.results.length!==undefined){var r=0,i=0;var n=0;for(m=0;m<P.results.length;m++){for(v=0;v<t.results.length;v++){if(t.results[v].Product===P.results[m].BillOfMaterialComponent){n+=1;T.p.push({lvl:P.results[m].IsSubItem,asm:P.results[m].IsAssembly,itm:P.results[m].BillOfMaterialItemNumber,bmc:P.results[m].BillOfMaterialComponent,mat:P.results[m].Material,qty:P.results[m].BillOfMaterialItemQuantity,gro:t.results[v].GrossWeight,net:t.results[v].NetWeight,tgt:t.results[v].GrossWeight*P.results[m].BillOfMaterialItemQuantity,tnt:t.results[v].NetWeight*P.results[m].BillOfMaterialItemQuantity,mgw:t.results[v].GrossWeight+" "+t.results[v].WeightUnit,mnw:t.results[v].NetWeight+" "+t.results[v].WeightUnit,cmd:P.results[m].ComponentDescription,wun:t.results[v].WeightUnit,cnt:n,dia:"",gol:""})}}}for(v=0;v<T.p.length;v++){if(T.p[v].asm.length===0){r=r+parseFloat(T.p[v].tnt);i=i+parseFloat(T.p[v].tgt)}}T.s.push({addNQ:r,addGQ:i,label:"Total"});D.read("/A_Product",{urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit",$filter:"(Product eq '"+e+"')"},async:false,success:function(e,t){var a=e.results[0].NetWeight,r=e.results[0].GrossWeight,i=e.results[0].WeightUnit;if(e.results.length===1){T.m.push({mmNW:a+" "+i,mmGW:r+" "+i});var n=JSON.parse(JSON.stringify(T.p));n[0].dia=a+" "+i;n[0].gol=r+" "+i;var u=new sap.ui.model.json.JSONModel;u.setSizeLimit(n.length);u.setData(n);s.getView().setModel(u,"OPM");o.close();l=new sap.ui.model.json.JSONModel;l.setSizeLimit(T.p.length);l.setData(T);s.getView().setModel(l,"BRF")}else{sap.m.MMessageToast.show("Issue in fetched Data")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},onInitGrouping:function(e){var a=$.sap.fm;if(n){var s=false;var l=false;var r=[];var i="lvl";var o=this.getView();var u=o.byId("tab");var g=u.getBinding("items");r.push(new sap.ui.model.Sorter(i,s,l));g.sort(r);n=false}else{this.mGroupFunctions={mat:function(e){var t=e.getProperty("mat");n=true;if(t===a){var s=e.getModel().oData.m[0].mmGW,l=e.getModel().oData.m[0].mmNW;return{key:t,text:t+Array(33).fill(" ").join("")+l+Array(6).fill(" ").join("")+s+Array(5).fill(" ").join("")}}else{n=true;var r=e.getModel().oData.p;var i=[];for(var o=0;o<r.length;o++){i.push(r[o].bmc)}var u=i.indexOf(t);var g=r[u].mnw;var d=r[u].mgw;return{key:t,text:t+Array(33).fill(" ").join("")+g+Array(6).fill(" ").join("")+d}}}};var u=this.byId("tab"),g=u.getBinding("items"),d,c=false,m,p=[],f="cnt";if(e){d=e;c=false;m=this.mGroupFunctions[d];p.push(new t(f,c,m));g.sort(p)}}},onUpdateFinished:function(e){var t,a=e.getSource(),s=e.getParameter("total");if(s&&a.getBinding("items").isLengthFinal()){t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitleCount",[s])}else{t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.bom.bomweight.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var a=this._oFrag.getFilterBar();this._oBasicSearchField=new s({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});a.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onFragNext:function(){if(!this._oFragPlant){this._oFragPlant=sap.ui.xmlfragment("com.bom.bomweight.Fragments.PlantHelp",this)}var e=this._oFragPlant.getTable();this.fTablePlant=e;e.setModel(this.oColModelPlant,"columns");this._oFrag.setRangeKeyFields([{label:"Plant",key:"Plant"}]);this._oFragPlant.open()},onValueHelpCancelPressPlant:function(){this._oFragPlant.close()},onFilterBarSearchPlant:function(){var e=this.getView().getModel("modelC");var t=this;o.open();e.read("/YY1_Plant_API",{async:false,success:function(e,a){var s=e.results.length;if(s===e.results.length){var l=new sap.ui.model.json.JSONModel;l.setData(e);var r=t._oFragPlant.getTable();r.setModel(l);o.close();r.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},onValueHelpOkPressPlant:function(e){var t=sap.ui.getCore().byId("PlantId"),a=e.getParameter("tokens")[0].getKey();t.updateInputField(a);this._oFragPlant.close()},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),a=e.getParameter("tokens")[0].getKey();t.updateInputField(a);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),a=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||a.length!==0){o.open();var s=this,l=this.getView().getModel("modelA"),r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),i=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,a),n=new Array(new sap.ui.model.Filter({filters:[r,i],and:true}));l.read("/MaterialBOM",{filters:n,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var a=e.results.length;if(a===e.results.length){var l=new sap.ui.model.json.JSONModel;l.setData(e);var r=s._oFrag.getTable();r.setModel(l);o.close();r.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onSearch:function(e){var t=e.getParameter("query"),a=[];if(t){a.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new l({filters:a,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onDataExport:function(){this.onExcelDownload(this)},handleGroupButtonPressed:function(){$.sap.n2=true;$.sap.n3=true;this.onInitGrouping("mat")},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("idPlant").setValue(t.toUpperCase())}})});