sap.ui.define(["com/bom/bomweight/controller/BaseController","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/m/SearchField","sap/ui/model/Filter","sap/m/MessageBox","com/bom/bomweight/util/formatter"],function(e,t,a,s,r,l,i){"use strict";var o=new sap.m.BusyDialog,n=false;var u=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,decimalSeparator:",",groupingEnabled:false});return e.extend("com.bom.bomweight.controller.View1",{onInit:function(){this.oColModel=new sap.ui.model.json.JSONModel("Columns/column.json");this.oColModelPlant=new sap.ui.model.json.JSONModel("Columns/columnPlant.json");var e=new a({worklistTableTitle:this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")});this.getView().setModel(e,"worklistView")},inox:i,onGo:function(){o.open();var e=this;l.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSearch()}if(t==="Cancel"){o.close()}},initialFocus:"OK"})},onBOMSearch:function(){var e=this.getView().byId("multiInput").getValue();$.sap.fm=e;var t=this.getView().byId("idPlant").getValue(),a=this.getView().byId("idBOMUsage").getValue();if(e.length===0||t.length===0||a.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");o.close()}else{$.sap.myVar=true;$.sap.myVars=true;var s=this;var r=new sap.ui.model.json.JSONModel;this.getView().setModel(r,"BRF");var l=[];var i=[];var n=false;var g="";var m=0;var d=true;var c=[];var f=0;var p=0;var h="";var M=0;var v=false;var B=new sap.ui.model.json.JSONModel;var w=new sap.ui.model.json.JSONModel;var I=new sap.ui.model.json.JSONModel;var O=[];var y=0;var b="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var P=new sap.ui.model.odata.ODataModel(b,true);P.setDefaultBindingMode("TwoWay");P.read("/MaterialBOM",{urlParameters:{$filter:"BillOfMaterialVariantUsage eq '"+a+"' and Plant eq '"+t+"' and Material eq '"+e+"'",$select:"Material"},async:false,success:function(e,a){for(var s=0;s<e.results.length;s++){l[s]=e.results[s].Material}if(e.results===undefined||e.results.length===0){o.close();sap.m.MessageToast.show("No Valid Records Found");return}var r="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var u=new sap.ui.model.odata.ODataModel(r,true);u.setDefaultBindingMode("TwoWay");f=l.length;do{c=[];c[0]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,l[p]);c[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t);u.read("/MaterialBOMItem",{filters:c,urlParameters:{$select:"BillOfMaterialCategory,BillOfMaterialVariant,BillOfMaterialVersion,BillOfMaterialItemNodeNumber,Material,Plant,BillOfMaterialItemUUID,ValidityStartDate,ValidityEndDate,EngineeringChangeDocument,BillOfMaterialComponent,BillOfMaterialItemCategory,BillOfMaterialItemNumber,BillOfMaterialItemUnit,BillOfMaterialItemQuantity,IsAssembly,ComponentDescription,BOMItemIsSalesRelevant,IsProductionRelevant,BOMItemIsCostingRelevant,IsEngineeringRelevant,RequiredComponent,IsSubItem,BillOfMaterial,SpecialProcurementType"},async:false,success:function(e,t){var a=e.results[0].BillOfMaterial;var s=e.results[0].BillOfMaterialCategory;var r=e.results[0].BillOfMaterialVariant;var l=e.results[0].BillOfMaterialVersion;var n=e.results[0].EngineeringChangeDocument;var f=e.results[0].Material;var p=e.results[0].Plant;var I="/MaterialBOM(BillOfMaterial='"+a+"',BillOfMaterialCategory='"+s+"',BillOfMaterialVariant='"+r+"',BillOfMaterialVersion='"+l+"',EngineeringChangeDocument='"+n+"',Material='"+f+"',Plant='"+p+"')";u.read(I,{filters:c,urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},async:false,success:function(e,t){h=e.BillOfMaterialVariantUsage},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});if(!v){}else{M=M+1;v=false}if(d){for(var b=0;b<e.results.length;b++){e.results[b].IsSubItem=M}w.setData(e);d=false}else{for(var P=0;P<e.results.length;P++){e.results[P].IsSubItem=M}B.setData(e);for(var F=0;F<B.getProperty("/results").length;F++){w.getProperty("/results").push(B.getProperty("/results/"+F))}}for(var F=0;F<e.results.length;F++){if(e.results[F].IsAssembly.length>0){g="X";i[m]=e.results[F].BillOfMaterialComponent;O[y]=e.results[F].BillOfMaterialComponent;y++;m++}}if(i.length>0){g="X"}else{g=""}},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}});p=p+1;if(p<l.length){n=true}else if(g.length>0){l=[];l=i;p=0;v=true;m=0;i=[];n=true}else{n=false}}while(n)},error:function(e){o.close();var t=JSON.parse(e.response.body);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){s.getView().byId("multiInput").setValue(null);s.getView().byId("idPlant").setValue(null);s.getView().byId("idBOMUsage").setValue(null);return}}})}});var F=w.getData();var S=[];var V=[];var N=[];var C=[];for(var x=0;x<F.results.length;x++){S.push(new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,F.results[x].BillOfMaterialComponent))}var A=new sap.ui.model.Filter({filters:S,and:false});var T=new Array(new sap.ui.model.Filter({filters:[A]}));var D={p:[],s:[],m:[]};var W=this.getView().getModel("modelB");W.read("/A_Product",{filters:[T],urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit,Product"},async:false,success:function(t,a){for(B=0;B<t.results.length;B++){V[B]=t.results[B].GrossWeight;N[B]=t.results[B].NetWeight;C[B]=t.results[B].WeightUnit}if(B===t.results.length&&t.results.length!==0&&t.results.length!==undefined){var l=0,i=0;var n=0;for(f=0;f<F.results.length;f++){for(B=0;B<t.results.length;B++){if(t.results[B].Product===F.results[f].BillOfMaterialComponent){n+=1;D.p.push({lvl:F.results[f].IsSubItem,asm:F.results[f].IsAssembly,itm:F.results[f].BillOfMaterialItemNumber,bmc:F.results[f].BillOfMaterialComponent,mat:F.results[f].Material,qty:F.results[f].BillOfMaterialItemQuantity,gro:t.results[B].GrossWeight,net:t.results[B].NetWeight,tgt:t.results[B].GrossWeight*F.results[f].BillOfMaterialItemQuantity,tnt:t.results[B].NetWeight*F.results[f].BillOfMaterialItemQuantity,mgw:t.results[B].GrossWeight+" "+t.results[B].WeightUnit,mnw:t.results[B].NetWeight+" "+t.results[B].WeightUnit,cmd:F.results[f].ComponentDescription,wun:t.results[B].WeightUnit,cnt:n,dia:"",gol:""})}}}for(B=0;B<D.p.length;B++){if(D.p[B].asm.length===0){l=l+parseFloat(D.p[B].tnt);i=i+parseFloat(D.p[B].tgt)}}D.s.push({addNQ:l,addGQ:i,label:"Total"});W.read("/A_Product",{urlParameters:{$select:"GrossWeight,NetWeight,WeightUnit",$filter:"(Product eq '"+e+"')"},async:false,success:function(e,t){var a=e.results[0].NetWeight,l=e.results[0].GrossWeight,i=e.results[0].WeightUnit;if(e.results.length===1){D.m.push({mmNW:a+" "+i,mmGW:l+" "+i});var n=JSON.parse(JSON.stringify(D.p));n[0].dia=u.format(a)+" "+i;n[0].gol=u.format(l)+" "+i;for(B=0;B<n.length;B++){n[B].net=u.format(n[B].net);n[B].gro=u.format(n[B].gro);n[B].tnt=u.format(n[B].tnt);n[B].tgt=u.format(n[B].tgt)}var g=new sap.ui.model.json.JSONModel;g.setSizeLimit(n.length);g.setData(n);s.getView().setModel(g,"OPM");o.close();r=new sap.ui.model.json.JSONModel;r.setSizeLimit(D.p.length);r.setData(D);s.getView().setModel(r,"BRF")}else{sap.m.MMessageToast.show("Issue in fetched Data")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})}},onInitGrouping:function(e){var a=$.sap.fm;if(n){var s=false;var r=false;var l=[];var i="lvl";var o=this.getView();var u=o.byId("tab");var g=u.getBinding("items");l.push(new sap.ui.model.Sorter(i,s,r));g.sort(l);n=false}else{this.mGroupFunctions={mat:function(e){var t=e.getProperty("mat");n=true;if(t===a){var s=e.getModel().oData.m[0].mmGW,r=e.getModel().oData.m[0].mmNW;return{key:t,text:t+Array(33).fill(" ").join("")+r+Array(6).fill(" ").join("")+s+Array(5).fill(" ").join("")}}else{n=true;var l=e.getModel().oData.p;var i=[];for(var o=0;o<l.length;o++){i.push(l[o].bmc)}var u=i.indexOf(t);var g=l[u].mnw;var m=l[u].mgw;return{key:t,text:t+Array(33).fill(" ").join("")+g+Array(6).fill(" ").join("")+m}}}};var u=this.byId("tab"),g=u.getBinding("items"),m,d=false,c,f=[],p="cnt";if(e){m=e;d=false;c=this.mGroupFunctions[m];f.push(new t(p,d,c));g.sort(f)}}},onUpdateFinished:function(e){var t,a=e.getSource(),s=e.getParameter("total");if(s&&a.getBinding("items").isLengthFinal()){t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitleCount",[s])}else{t=this.getView().getModel("i18n").getResourceBundle().getText("worklistTableTitle")}this.getView().getModel("worklistView").setProperty("/worklistTableTitle",t)},onFrag:function(e){if(!this._oFrag){this._oFrag=sap.ui.xmlfragment("com.bom.bomweight.Fragments.Help",this)}var t=this._oFrag.getTable();this.fTable=t;t.setModel(this.oColModel,"columns");this._oFrag.setRangeKeyFields([{label:"Material",key:"Material"}]);var a=this._oFrag.getFilterBar();this._oBasicSearchField=new s({showSearchButton:true,search:this.onSearch.bind(this),placeholder:"Search by below 'Material'",enableSuggestions:true});a.setBasicSearch(this._oBasicSearchField);this._oFrag.open()},onFragNext:function(){if(!this._oFragPlant){this._oFragPlant=sap.ui.xmlfragment("com.bom.bomweight.Fragments.PlantHelp",this)}var e=this._oFragPlant.getTable();this.fTablePlant=e;e.setModel(this.oColModelPlant,"columns");this._oFrag.setRangeKeyFields([{label:"Plant",key:"Plant"}]);this._oFragPlant.open()},onValueHelpCancelPressPlant:function(){this._oFragPlant.close()},onFilterBarSearchPlant:function(){var e=this.getView().getModel("modelC");var t=this;o.open();e.read("/YY1_Plant_API",{async:false,success:function(e,a){var s=e.results.length;if(s===e.results.length){var r=new sap.ui.model.json.JSONModel;r.setData(e);var l=t._oFragPlant.getTable();l.setModel(r);o.close();l.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){return}}})}})},onValueHelpOkPressPlant:function(e){var t=sap.ui.getCore().byId("PlantId"),a=e.getParameter("tokens")[0].getKey();t.updateInputField(a);this._oFragPlant.close()},onValueHelpOkPress:function(e){var t=this.getView().byId("multiInput"),a=e.getParameter("tokens")[0].getKey();t.updateInputField(a);this.getView().byId("idPlant").updateInputField(sap.ui.getCore().byId("PlantId").getValue());this.getView().byId("idBOMUsage").updateInputField(sap.ui.getCore().byId("BOMId").getValue());this._oFrag.close()},onValueHelpCancelPress:function(){this._oFrag.close()},onFilterBarSearch:function(e){var t=sap.ui.getCore().byId("PlantId").getValue(),a=sap.ui.getCore().byId("BOMId").getValue();if(t.length!==0||a.length!==0){o.open();var s=this,r=this.getView().getModel("modelA"),l=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,t),i=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,a),n=new Array(new sap.ui.model.Filter({filters:[l,i],and:true}));r.read("/MaterialBOM",{filters:n,urlParameters:{$select:"Material,ProductDescription"},async:false,success:function(e,t){var a=e.results.length;if(a===e.results.length){var r=new sap.ui.model.json.JSONModel;r.setData(e);var l=s._oFrag.getTable();l.setModel(r);o.close();l.bindRows("/results")}else{o.close();sap.m.MessageToast.show("Issue in Odata call")}},error:function(e){o.close();var t=JSON.parse(e.responseText);sap.m.MessageBox.show(t.error.message.value,{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){sap.ui.getCore().byId("PlantId").setValue(null);sap.ui.getCore().byId("BOMId").setValue(null);return}}})}})}else{sap.m.MessageBox.warning("Please enter all mandatory fields.")}},onSearch:function(e){var t=e.getParameter("query"),a=[];if(t){a.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t))}this.filterTable(new r({filters:a,and:true}))},filterTable:function(e){var t=this._oFrag;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onDataExport:function(){this.onExcelDownload(this)},handleGroupButtonPressed:function(){$.sap.n2=true;$.sap.n3=true;this.onInitGrouping("mat")},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("idPlant").setValue(t.toUpperCase())}})});